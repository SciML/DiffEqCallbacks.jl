<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Manifold Projection · DiffEqCallbacks.jl</title><meta name="title" content="Manifold Projection · DiffEqCallbacks.jl"/><meta property="og:title" content="Manifold Projection · DiffEqCallbacks.jl"/><meta property="twitter:title" content="Manifold Projection · DiffEqCallbacks.jl"/><meta name="description" content="Documentation for DiffEqCallbacks.jl."/><meta property="og:description" content="Documentation for DiffEqCallbacks.jl."/><meta property="twitter:description" content="Documentation for DiffEqCallbacks.jl."/><meta property="og:url" content="https://docs.sciml.ai/DiffEqCallbacks/stable/projection/"/><meta property="twitter:url" content="https://docs.sciml.ai/DiffEqCallbacks/stable/projection/"/><link rel="canonical" href="https://docs.sciml.ai/DiffEqCallbacks/stable/projection/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="DiffEqCallbacks.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">DiffEqCallbacks.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../output_saving/">Output and Saving Controls</a></li><li><a class="tocitem" href="../integrating/">Numerical Integration Callbacks</a></li><li><a class="tocitem" href="../timed_callbacks/">Timed Callbacks</a></li><li><a class="tocitem" href="../steady_state/">Steady State Callbacks</a></li><li><a class="tocitem" href="../step_control/">Step Control Callbacks</a></li><li class="is-active"><a class="tocitem" href>Manifold Projection</a></li><li><a class="tocitem" href="../uncertainty_quantification/">Uncertainty Quantification</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Manifold Projection</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Manifold Projection</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SciML/DiffEqCallbacks.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SciML/DiffEqCallbacks.jl/blob/master/docs/src/projection.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Manifold-Projection"><a class="docs-heading-anchor" href="#Manifold-Projection">Manifold Projection</a><a id="Manifold-Projection-1"></a><a class="docs-heading-anchor-permalink" href="#Manifold-Projection" title="Permalink"></a></h1><p>The following callbacks are designed to provide post-step modifications to preserve geometric behaviors in the solution.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="DiffEqCallbacks.ManifoldProjection" href="#DiffEqCallbacks.ManifoldProjection"><code>DiffEqCallbacks.ManifoldProjection</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">ManifoldProjection(
    manifold; nlsolve = missing, save = true, autonomous = nothing,
    manifold_jacobian = nothing, autodiff = nothing, kwargs...)</code></pre><p>In many cases, you may want to declare a manifold on which a solution lives. Mathematically, a manifold <code>M</code> is defined by a function <code>g</code> as the set of points where <code>g(u) = 0</code>. An embedded manifold can be a lower dimensional object which constrains the solution. For example, <code>g(u) = E(u) - C</code> where <code>E</code> is the energy of the system in state <code>u</code>, meaning that the energy must be constant (energy preservation). Thus by defining the manifold the solution should live on, you can retain desired properties of the solution.</p><p><code>ManifoldProjection</code> projects the solution of the differential equation to the chosen manifold <code>g</code>, conserving a property while conserving the order. It is a consequence of convergence proofs both in the deterministic and stochastic cases that post-step projection to manifolds keep the same convergence rate, thus any algorithm can be easily extended to conserve properties. If the solution is supposed to live on a specific manifold or conserve such property, this guarantees the conservation law without modifying the convergence properties.</p><p><strong>Arguments</strong></p><ul><li><code>manifold</code>: The residual function for the manifold. If the ODEProblem is an inplace problem, then <code>g</code> must be an inplace function of form <code>g(resid, u, p)</code> or <code>g(resid, u, p, t)</code> and similarly if the ODEProblem is an out-of-place problem then <code>g</code> must be a function of form <code>g(u, p)</code> or <code>g(u, p, t)</code>.</li></ul><p><strong>Keyword Arguments</strong></p><ul><li><code>nlsolve</code>: Defaults to a special single-factorize algorithm (denoted by <code>missing</code>) that would work in most cases (See [1] for details). Alternatively, a nonlinear solver as defined in the <a href="https://docs.sciml.ai/NonlinearSolve/stable/basics/solve/">NonlinearSolve.jl format</a> can be specified. Additionally if NonlinearSolve.jl is loaded and <code>nothing</code> is specified a polyalgorithm is used.</li><li><code>save</code>: Whether to do the standard saving (applied after the callback)</li><li><code>autonomous</code>: Whether <code>g</code> is an autonomous function of the form <code>g(resid, u, p)</code> or <code>g(u, p)</code>. Specify it as <code>Val(::Bool)</code> to disable runtime branching. If <code>nothing</code>, we attempt to infer it from the signature of <code>g</code>.</li><li><code>residual_prototype</code>: The size of the manifold residual. If it is not specified, we assume it to be same as <code>u</code> in the inplace case. Else we run a single evaluation of <code>manifold</code> to determine the size.</li><li><code>kwargs</code>: All other keyword arguments are passed to <a href="https://docs.sciml.ai/NonlinearSolve/stable/basics/solve/">NonlinearSolve.jl</a> if <code>nlsolve</code> is not <code>missing</code>.</li><li><code>autodiff</code>: The autodifferentiation algorithm to use to compute the Jacobian if <code>manifold_jacobian</code> is not specified. This must be specified if <code>manifold_jacobian</code> is not specified.</li><li><code>manifold_jacobian</code>: The Jacobian of the manifold (wrt the state). This has the same signature as <code>manifold</code> and the first argument is the Jacobian if inplace.</li></ul><p><strong>Saveat Warning</strong></p><p>Note that the <code>ManifoldProjection</code> callback modifies the endpoints of the integration intervals and thus breaks assumptions of internal interpolations. Because of this, the values for given by saveat will not be order-matching. However, the interpolation error can be proportional to the change by the projection, so if the projection is making small changes then one is still safe. However, if there are large changes from each projection, you should consider only saving at stopping/projection times. To do this, set <code>tstops</code> to the same values as <code>saveat</code>. There is a performance hit by doing so because now the integrator is forced to stop at every saving point, but this is guerenteed to match the order of the integrator even with the ManifoldProjection.</p><p><strong>References</strong></p><p>[1] Ernst Hairer, Christian Lubich, Gerhard Wanner. Geometric Numerical Integration: Structure-Preserving Algorithms for Ordinary Differential Equations. Berlin ; New York :Springer, 2002.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/SciML/DiffEqCallbacks.jl/blob/9283f3266b665c73d4214fcc97ecef75afb40179/src/manifold.jl#L1-L69">source</a></section></article><h3 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h3><p>Here we solve the harmonic oscillator:</p><pre><code class="language-julia hljs">using OrdinaryDiffEq, DiffEqCallbacks, NonlinearSolve, Plots, ADTypes

u0 = ones(2)
function f(du, u, p, t)
    du[1] = u[2]
    du[2] = -u[1]
end
prob = ODEProblem(f, u0, (0.0, 100.0))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr38_2" style="color:#56b6c2">ODEProblem</span> with uType <span class="sgr38_2" style="color:#56b6c2">Vector{Float64}</span> and tType <span class="sgr38_2" style="color:#56b6c2">Float64</span>. In-place: <span class="sgr38_2" style="color:#56b6c2">true</span>
Non-trivial mass matrix: <span class="sgr38_2" style="color:#56b6c2">false</span>
timespan: (0.0, 100.0)
u0: 2-element Vector{Float64}:
 1.0
 1.0</code></pre><div class="admonition is-info" id="Note-ccb99ccc1f75fbe7"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-ccb99ccc1f75fbe7" title="Permalink"></a></header><div class="admonition-body"><p>Note that NonlinearSolve.jl is required to be imported for ManifoldProjection</p></div></div><p>However, this problem is supposed to conserve energy, and thus we define our manifold to conserve the sum of squares:</p><pre><code class="language-julia hljs">function g(resid, u, p, t)
    resid[1] = u[2]^2 + u[1]^2 - 2
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">g (generic function with 1 method)</code></pre><p>To build the callback, we just call</p><pre><code class="language-julia hljs">cb = ManifoldProjection(g; autodiff = AutoForwardDiff(), resid_prototype = zeros(1))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">SciMLBase.DiscreteCallback{Returns{Bool}, ManifoldProjection{DiffEqCallbacks.UntypedNonAutonomousFunction{typeof(Main.g)}, Nothing, ADTypes.AutoForwardDiff{nothing, Nothing}, Missing, Base.Pairs{Symbol, Vector{Float64}, Tuple{Symbol}, @NamedTuple{resid_prototype::Vector{Float64}}}, Nothing}, typeof(DiffEqCallbacks.initialize_manifold_projection), typeof(SciMLBase.FINALIZE_DEFAULT), Nothing}(Returns{Bool}(true), ManifoldProjection{DiffEqCallbacks.UntypedNonAutonomousFunction{typeof(Main.g)}, Nothing, ADTypes.AutoForwardDiff{nothing, Nothing}, Missing, Base.Pairs{Symbol, Vector{Float64}, Tuple{Symbol}, @NamedTuple{resid_prototype::Vector{Float64}}}, Nothing}(DiffEqCallbacks.UntypedNonAutonomousFunction{typeof(Main.g)}(false, Main.g, nothing), nothing, ADTypes.AutoForwardDiff(), nothing, missing, Base.Pairs(:resid_prototype =&gt; [0.0]), nothing), DiffEqCallbacks.initialize_manifold_projection, SciMLBase.FINALIZE_DEFAULT, Bool[0, 1], nothing)</code></pre><p>Using this callback, the Runge-Kutta method <code>Vern7</code> conserves energy. Note that the standard saving occurs after the step and before the callback, and thus we set <code>save_everystep=false</code> to turn off all standard saving and let the callback save after the projection is applied.</p><pre><code class="language-julia hljs">sol = solve(prob, Vern7(), save_everystep = false, callback = cb)
@show sol[end][1]^2 + sol[end][2]^2 ≈ 2</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">true</code></pre><pre><code class="language-julia hljs">using Plots
plot(sol, idxs = (1, 2))</code></pre><img src="85992e99.svg" alt="Example block output"/></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../step_control/">« Step Control Callbacks</a><a class="docs-footer-nextpage" href="../uncertainty_quantification/">Uncertainty Quantification »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.13.0 on <span class="colophon-date" title="Friday 20 June 2025 20:11">Friday 20 June 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
